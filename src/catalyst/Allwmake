#!/bin/sh
cd "${0%/*}" || exit                                # Run from this directory
. ${WM_PROJECT_DIR:?}/wmake/scripts/cmakeFunctions  # The cmake functions
#------------------------------------------------------------------------------

# CMake into objectsDir with external dependency
#
# 1 - depend
# 2 - sourceDir
# 3... optional cmake defines
#
# Available directly in OpenFOAM-1812 but left here for a while
# to ensure we can build with slightly older versions too (2018-11-29)
#
unset -f cmakeVersionedInstall 2>/dev/null
cmakeVersionedInstall()
{
    local depend="$1"
    local sourceDir="$2"
    shift 2
    local objectsDir sentinel

    # Where generated files are stored
    objectsDir=$(findObjectDir "$sourceDir") || exit 1 # Fatal

    # Version changed
    sentinel=$(sameDependency "$depend" "$sourceDir") || \
        rm -rf "$objectsDir" > /dev/null 2>&1

    mkdir -p "$objectsDir" \
    && (cd "$objectsDir" && _cmake "$@" "$sourceDir" && make install) \
    && echo "$depend" >| "${sentinel:-/dev/null}"
}

#------------------------------------------------------------------------------

# Installation prefix: user/group/other or custom
case "$1" in
    -prefix=u) prefix="${FOAM_USER_LIBBIN%/*}" ;; # user
    -prefix=g) prefix="${FOAM_SITE_LIBBIN%/*}" ;; # group
    -prefix=o) prefix="${FOAM_LIBBIN%/*}" ;; # other/openfoam
    -prefix=*) prefix="${1#*=}" ;;
esac

# Default is openfoam (FOAM_LIBBIN)
: "${prefix:=$WM_PROJECT_DIR/platforms/$WM_OPTIONS}"

cmakeOpts="-DCMAKE_INSTALL_PREFIX=$prefix"

#------------------------------------------------------------------------------

echo "======================================================================"
echo "${PWD##*/} : $PWD"
echo

unset depend
if [ -d "$ParaView_DIR" ]
then
    depend="ParaView_DIR=$ParaView_DIR"
fi


if [ "$targetType" = objects ]
then
    depend=ignore
elif [ -n "$depend" ]
then
    if command -v cmake >/dev/null
    then
        echo "catalyst prefix : $prefix"
        cmakeVersionedInstall "$depend" "$PWD" "$cmakeOpts" || {
            echo
            echo "    WARNING: incomplete build of ParaView Catalyst"
            echo
        }
    else
        echo "==> skip catalyst (needs cmake)"
    fi
else
    echo "WARNING: skip ParaView Catalyst (missing or incorrrect ParaView)"
fi

echo "======================================================================"

#------------------------------------------------------------------------------
